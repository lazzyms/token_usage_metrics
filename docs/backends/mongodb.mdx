---
title: MongoDB Backend
description: "Flexible document-based token usage tracking with MongoDB"
icon: "leaf"
---

## Overview

MongoDB backend provides flexible schema and powerful aggregation framework. Ideal for applications requiring document-based queries and horizontal scaling.

<CardGroup cols={2}>
  <Card title="Performance" icon="gauge-high">
    ~5,000 writes/sec
  </Card>
  <Card title="Latency" icon="clock">
    &lt;10ms (p99)
  </Card>
</CardGroup>

## Installation

```bash
uv add token-usage-metrics[mongo]
```

## Setup

### Start MongoDB with Docker

```bash
# Basic setup
docker run -d -p 27017:27017 mongo:7

# With persistence
docker run -d -p 27017:27017 \
  -v mongodb-data:/data/db \
  mongo:7

# With authentication
docker run -d -p 27017:27017 \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=yourpassword \
  mongo:7
```

### Production Options

<Tabs>
  <Tab title="MongoDB Atlas">
    ```bash
    mongodb+srv://user:pass@cluster.mongodb.net/?retryWrites=true&w=majority
    ```
  </Tab>

{" "}

<Tab title="AWS DocumentDB">
  ```bash
  mongodb://user:pass@docdb-cluster.cluster-xxx.region.docdb.amazonaws.com:27017/?ssl=true&replicaSet=rs0
  ```
</Tab>

  <Tab title="Self-Hosted">
    ```bash
    mongodb://user:password@localhost:27017/?authSource=admin
    ```
  </Tab>
</Tabs>

## Usage Example

### Basic Usage

```python
import asyncio
from token_usage_metrics import TokenUsageClient
from token_usage_metrics.config import Settings

async def main():
    # Initialize with MongoDB
    settings = Settings(
        backend="mongodb",
        mongodb_url="mongodb://localhost:27017",
        mongodb_database="token_usage"
    )
    client = await TokenUsageClient.from_settings(settings)

    # Log token usage
    await client.log(
        project="chatbot",
        request_type="chat",
        input_tokens=100,
        output_tokens=50
    )

    # Query events
    events, _ = await client.query(project="chatbot")
    print(f"Total events: {len(events)}")

    await client.aclose()

asyncio.run(main())
```

### With Metadata

```python
async def main():
    settings = Settings(
        backend="mongodb",
        mongodb_url="mongodb://localhost:27017",
        mongodb_database="token_usage"
    )
    client = await TokenUsageClient.from_settings(settings)

    # Log with custom metadata
    await client.log(
        "my_app", "chat",
        input_tokens=150,
        output_tokens=75,
        metadata={
            "model": "gpt-4",
            "user_id": "alice",
            "session": "abc123"
        }
    )

    await client.aclose()
```

### Batch Logging

```python
async def main():
    settings = Settings(
        backend="mongodb",
        mongodb_url="mongodb://localhost:27017",
        mongodb_database="token_usage"
    )
    client = await TokenUsageClient.from_settings(settings)

    # Log multiple events
    events = [
        {"project": "app1", "type": "chat", "input_tokens": 100, "output_tokens": 50},
        {"project": "app1", "type": "chat", "input_tokens": 120, "output_tokens": 60},
        {"project": "app2", "type": "embedding", "input_tokens": 200, "output_tokens": 0},
    ]

    for event in events:
        await client.log(
            event["project"],
            event["type"],
            input_tokens=event["input_tokens"],
            output_tokens=event["output_tokens"]
        )

    # Force flush
    await client.flush()

    await client.aclose()
```

### Query and Aggregate

```python
from datetime import datetime, timedelta, timezone

async def main():
    settings = Settings(
        backend="mongodb",
        mongodb_url="mongodb://localhost:27017",
        mongodb_database="token_usage"
    )
    client = await TokenUsageClient.from_settings(settings)

    # Query recent events
    events, cursor = await client.query(
        project="chatbot",
        limit=100
    )

    # Get daily aggregates
    daily_stats = await client.aggregate(
        group_by="day",
        time_from=datetime.now(timezone.utc) - timedelta(days=7),
        project="chatbot"
    )

    print("Daily Usage:")
    for bucket in daily_stats:
        print(f"{bucket.start.date()}: {bucket.metrics['total_tokens']} tokens")

    await client.aclose()
```

## Configuration

### Environment Variables

```bash
export TUM_BACKEND=mongodb
export TUM_MONGODB_URL=mongodb://localhost:27017
export TUM_MONGODB_DATABASE=token_usage
export TUM_BUFFER_SIZE=1000
export TUM_FLUSH_INTERVAL=1.0
```

### Using Settings Object

```python
from token_usage_metrics import TokenUsageClient
from token_usage_metrics.config import Settings

settings = Settings(
    backend="mongodb",
    mongodb_url="mongodb://localhost:27017",
    mongodb_database="token_usage",

    # Performance tuning
    buffer_size=1000,
    flush_interval=1.0,
    flush_batch_size=200,

    # Connection pooling
    mongodb_max_pool_size=10,
    mongodb_min_pool_size=1,
)

client = await TokenUsageClient.from_settings(settings)
```

## Data Retention

MongoDB supports TTL indexes for automatic data expiration:

```python
# Option 1: Automatic cleanup with TTL (configure at database level)
# The backend automatically creates indexes on first connection

# Option 2: Manual cleanup
from datetime import datetime, timedelta, timezone
from token_usage_metrics import DeleteOptions

async def cleanup_old_data(client):
    """Delete data older than 90 days"""
    cutoff = datetime.now(timezone.utc) - timedelta(days=90)

    options = DeleteOptions(
        project_name="my_app",
        time_to=cutoff,
        include_aggregates=True
    )

    result = await client.delete_project(options)
    print(f"Deleted {result.events_deleted} events")
```

## Best Practices

<AccordionGroup>
  <Accordion title="Use Connection Pooling">
    Configure pool size for your workload:
    
    ```python
    settings = Settings(
        backend="mongodb",
        mongodb_url="mongodb://localhost:27017",
        mongodb_database="token_usage",
        mongodb_max_pool_size=20,
        mongodb_min_pool_size=5
    )
    ```
  </Accordion>

  <Accordion title="Monitor Performance">
    Enable profiling to track slow queries:
    
    ```javascript
    // In MongoDB shell
    db.setProfilingLevel(2);
    db.system.profile.find({ millis: { $gt: 100 } }).sort({ ts: -1 });
    ```
  </Accordion>

  <Accordion title="Use Indexes">
    Indexes are automatically created, but monitor their usage:
    
    ```javascript
    // Check index usage
    db.usage_events.aggregate([{ $indexStats: {} }]);
    ```
  </Accordion>
</AccordionGroup>

<CardGroup cols={2}>
  <Card title="Previous: PostgreSQL" icon="database" href="/backends/postgres">
    PostgreSQL backend documentation
  </Card>
  <Card title="Next: Supabase" icon="cloud" href="/backends/supabase">
    Supabase backend documentation
  </Card>
</CardGroup>
